<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>
      querySelector vs getElementsByClassName vs TreeWalker benchmark
    </title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        line-height: 1.5;
        margin: 2rem;
      }
      h1 {
        max-width: 40ch;
        text-wrap: balance;
      }
      pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 8px;
      }
      button {
        font-size: 1rem;
        padding: 0.5rem 1rem;
      }
    </style>
  </head>
  <body>
    <h1>Benchmark: querySelectorAll vs getElementsByClassName vs TreeWalker</h1>

    <p>
      This test builds a large DOM tree and compares the time to find elements
      with <code>data-attr</code>.
    </p>

    <label>
      Number of elements:
      <input id="count" type="number" value="10000" min="1000" step="1000">
    </label>
    <button id="run">Run benchmark</button>

    <pre id="output"></pre>

    <section id="tree"></section>

    <script>
      const count = document.getElementById("count");
      const run = document.getElementById("run");
      const output = document.getElementById("output");
      const tree = document.getElementById("tree");

      function log(...args) {
        output.textContent += args.join(" ") + "\n";
      }

      function buildDOM(count) {
        const frag = document.createDocumentFragment();
        for (let i = 0; i < count; i++) {
          const div = document.createElement("div");

          // 10% tagged
          if (i % 10 === 0) {
            div.setAttribute("data-attr", "x");
            div.classList.add("data-attr");
          }

          frag.appendChild(div);
        }
        tree.replaceChildren(frag);
      }

      function benchmarkAttributeSelector() {
        const start = performance.now();
        const matches = document.querySelectorAll("[data-attr]");
        const end = performance.now();
        return { time: end - start, count: matches.length };
      }

      function benchmarkClassSelector() {
        const start = performance.now();
        const matches = document.getElementsByClassName("data-attr");
        const end = performance.now();
        return { time: end - start, count: matches.length };
      }

      function benchmarkTreeWalker() {
        const walker = document.createTreeWalker(
          document.body,
          NodeFilter.SHOW_ELEMENT,
        );
        const results = [];
        const start = performance.now();
        let node;
        while ((node = walker.nextNode())) {
          if (node.hasAttribute("data-attr")) results.push(node);
        }
        const end = performance.now();
        return { time: end - start, count: results.length };
      }

      run.onclick = () => {
        output.textContent = "";
        const value = count.valueAsNumber;

        log(`Building ${value} elements...`);
        buildDOM(value);

        log("\nRunning querySelectorAll...");
        const qsa = benchmarkAttributeSelector();

        log(
          `querySelectorAll: ${
            qsa.time.toFixed(2)
          } ms (${qsa.count} matches)`,
        );

        log("\nRunning getElementsByClassName...");
        const bcn = benchmarkClassSelector();

        log(
          `getElementsByClassName: ${
            bcn.time.toFixed(2)
          } ms (${bcn.count} matches)`,
        );

        log("\nRunning TreeWalker...");
        const tw = benchmarkTreeWalker();

        log(
          `TreeWalker: ${tw.time.toFixed(2)} ms (${tw.count} matches)`,
        );

        log("\nResult:");
        log(
          `querySelectorAll is ${
            (tw.time / qsa.time).toFixed(1)
          }Ã— faster than TreeWalker.`,
        );
      };
    </script>
  </body>
</html>
